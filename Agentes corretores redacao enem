# Instalar as bibliotecas necess√°rias
%pip install -q google-adk google-generativeai

# Imports
import os
import re
import time
from google.colab import userdata
from google.adk.sessions import InMemorySessionService
from google.adk.runners import Runner
from google.adk.agents import LlmAgent, SequentialAgent
from google.genai import types
import ipywidgets as widgets
from IPython.display import display

# Configura√ß√£o da API
api_key = userdata.get("GOOGLE_API_KEY")
os.environ["GOOGLE_API_KEY"] = api_key

MODEL_ID = "gemini-1.5-flash"
DELAY_ENTRE_CHAMADAS = 5  # Aumentar se ocorrer erro 429

# Reda√ß√µes exemplo 
redacao_nota_alta = """Reda√ß√£o nota alta (960)

TEMA: Carnaval e apropria√ß√£o cultural 

Carnaval √© alegria, divers√£o, contraven√ß√£o. √â o momento de se despir do ma√ßante compromisso cotidiano das rela√ß√µes profissionais e se permitir sorrir e brincar. Por isso, usar fantasias, roupas coloridas, chap√©us estilizados e outros adere√ßos, que nos permitam compartilhar essa felicidade com outros cidad√£os, n√£o pode ser encarado como ofensivo ou uma apropria√ß√£o indevida de uma cultura por outra.

√â importante salientar, inicialmente, que as pessoas v√£o para as ruas para se divertir, esquecer por instantes os problemas e lutas cotidianas. Querem comida, divers√£o e arte para dar um sentido mais amplo a sua exist√™ncia. O que prevalece nesse momento √© a brincadeira, o l√∫dico, o entretenimento, passando ao longe a ideia de hostilizar e humilhar qualquer segmento ideol√≥gico e cultural, mesmo a cultura ind√≠gena, t√£o sofrida e desrespeitada, principalmente pela classe pol√≠tica.

Conv√©m ressaltar que o desrespeito n√£o adv√©m do fato de as pessoas usarem cocares ou adere√ßos que fa√ßam refer√™ncia √† cultura ind√≠gena. Ele se consolida na n√£o aceita√ß√£o da forma em que eles vivem, no preconceito contra os nativos, na hostilidade que sofrem ou sofreram, como no caso do ind√≠gena incendiado em um ponto de √¥nibus em Bras√≠lia, na invas√£o e expuls√£o de suas terras, no pensamento estilizado de que eles s√£o vagabundos. Esses fatores, somados, revelam um profundo desprezo e demonstram o quanto precisamos fazer e transformar para garantir a eles uma exist√™ncia digna.

Com isso, focar a aten√ß√£o em fantasias de carnaval √© perder tempo com pol√™micas sup√©rfluas diante do gigantesco desafio de eliminar as graves agress√µes sofridas historicamente. Eles precisam de respeito, reconhecimento, seguran√ßa e que seus direitos, como cidad√£os brasileiros, sejam respeitados. Necessitam que o governo garanta a inviolabilidade do seu territ√≥rio para n√£o se tornarem v√≠timas de exploradores gananciosos. Por fim, cabe aos governantes e √† sociedade civil organizada mudar o rumo dessa verdadeira trag√©dia para que eles n√£o percam sua identidade.

Coment√°rio geral
O texto s√≥ n√£o recebe a nota m√°xima devido √†s palavras ou express√µes inadequadas, que foram assinaladas em vermelho. "Contraven√ß√£o", n√£o est√° totalmente incorreto, pois √© sin√¥nimo de "transgress√£o", mas a palavra √© mais usada para referir-se a ilegalidades. A cita√ß√£o dos Tit√£s ("comida, divers√£o e arte") √© inadequada, pois "comida" propriamente dita nada tem que ver com carnaval. "Segmento ideol√≥gico e cultural" √© uma express√£o pretensiosa e amb√≠gua. O autor est√° se referindo √© a grupos √©tnicos e culturais. Por "pensamento estilizado", aparentemente, o autor quis dizer pensamento "estereotipado". Enfim, todos os trechos em vermelho destoam do texto, que, de resto, revela um estilo propriamente autoral. As muitas qualidades do texto n√£o se referem s√≥ √† linguagem, em todas as outras compet√™ncias o autor teve um desempenho excelente, redigindo uma disserta√ß√£o exemplar, em termos de argumenta√ß√£o, coes√£o e coer√™ncia textual.

Compet√™ncias avaliadas
As notas s√£o definidas segundo os crit√©rios da pontua√ß√£o do MEC

T√≠tulo/nota (0 a 1000):
1. Demonstrar dom√≠nio da norma culta da l√≠ngua escrita ‚Äî 160
2. Compreender a proposta da reda√ß√£o e aplicar conceito das v√°rias √°reas de conhecimento para desenvolver o tema, dentro dos limites estruturais do texto dissertativo-argumentativo ‚Äî 200
3. Selecionar, relacionar, organizar e interpretar informa√ß√µes, fatos, opini√µes e argumentos em defesa de um ponto de vista ‚Äî 200
4. Demonstrar conhecimento dos mecanismos lingu√≠sticos necess√°rios para a constru√ß√£o da argumenta√ß√£o ‚Äî 200
5. Elaborar a proposta de solu√ß√£o para o problema abordado, mostrando respeito aos valores humanos e considerando a diversidade sociocultural ‚Äî 200
"""

redacao_nota_baixa = """reda√ß√£o nota baixa (160)

TEMA: Carnaval e apropria√ß√£o cultural 

A apropria√ß√£o cultural cont√≠nua das escolas de samba sobre a diversidade de culturas em suas alegorias e fantasias, expressam fantasias expressam algo sem ao menos ter conhecimento sobre as suas origens e tradi√ß√µes.

Em seu v√≠deo publicado no Youtube, a ativista Kat√∫ Mirim relata como a sociedade exp√µe certa cultura e seus modos de agir ao p√∫blico sem haver estudado sobre o seu fato hist√≥rico e a cada s√≠mbolo retratado, torna-se ato de racismo.

Desde o per√≠odo colonial, √© l√≠cito dizer que h√° uma grande miscigena√ß√£o de ra√ßas, idiomas e diversas culturas no Brasil. E isso faz que a etnia na qual √© alvo pertin√™ncia seja aberta de modo que tenha conhecimento sobre seus desafios e dificuldades di√°rias e a cada objeto simb√≥lico estudado. N√£o tendo teorias sobre o tema abordado pode gerar conflitos entre as ra√ßas e a sociedade, gerando viol√™ncia, desrespeito e racismo.

Ademais, a persist√™ncia em demonstrar multiculturas encaradas como homenagem se torna uma ofensa. Tais povos, como, por exemplo, negros e ind√≠genas, quando possuem acess√≥rios, roupas e outros objetos do povo branco, t√™m olhares de discrimina√ß√£o sobre a sociedade, encaradas de forma etnoc√™ntrica.

Por tudo isso, o Minist√©rio da Educa√ß√£o deve apresentar √† comunidade, em forma de palestras e pr√°ticas em todos os institutos abertos ao corpo social, a diversidade de grupos que h√° em nosso pa√≠s, e que saibam usufruir deste conhecimento e expor tal etnia em grandes eventos com fatos relatados.

Coment√°rio geral
Lamentavelmente, o autor mal consegue se expressar por escrito. √â at√© poss√≠vel encontrar no texto uma cr√≠tica √† apropria√ß√£o cultural, mas em meio a um caos lingu√≠stico enorme. A escolha do vocabul√°rio e sua combina√ß√£o em frases que t√™m a sintaxe truncada ou que, simplesmente, n√£o apresentam um m√≠nimo de ordem sint√°tica acabam por comprometer todo o texto. N√£o h√° uma argumenta√ß√£o expl√≠cita na condena√ß√£o da apropria√ß√£o cultural, h√° apenas uma s√©rie de afirma√ß√µes confusas, que talvez fa√ßam todo o sentido na cabe√ßa do autor, mas ele n√£o consegue deix√°-la clara para o leitor, quanto mais persuadi-lo? O autor precisa aprender a organizar suas ideias, fazendo um esquema daquilo que ele pensa, antes de redigir. Precisa ter em mente que √© necess√°rio ser compreendido. Do contr√°rio, o resultado √© t√£o prec√°rio que mal pode ser corrigido. A √∫nica salva√ß√£o para o texto seria redigi-lo novamente, por completo.

Compet√™ncias avaliadas
As notas s√£o definidas segundo os crit√©rios da pontua√ß√£o do MEC

T√≠tulo/nota (0 a 1000):
1. Demonstrar dom√≠nio da norma culta da l√≠ngua escrita ‚Äî 20
2. Compreender a proposta da reda√ß√£o e aplicar conceito das v√°rias √°reas de conhecimento para desenvolver o tema, dentro dos limites estruturais do texto dissertativo-argumentativo ‚Äî 80
3. Selecionar, relacionar, organizar e interpretar informa√ß√µes, fatos, opini√µes e argumentos em defesa de um ponto de vista ‚Äî 20
4. Demonstrar conhecimento dos mecanismos lingu√≠sticos necess√°rios para a constru√ß√£o da argumenta√ß√£o ‚Äî 20
5. Elaborar a proposta de solu√ß√£o para o problema abordado, mostrando respeito aos valores humanos e considerando a diversidade sociocultural ‚Äî 20
"""

# Crit√©rios das compet√™ncias do ENEM
competencias = {
    "competencia_1": """
1. Dom√≠nio da escrita formal da l√≠ngua portuguesa
√â avaliado se a reda√ß√£o do participante est√° adequada √†s regras de ortografia, como acentua√ß√£o, ortografia, uso de h√≠fen, emprego de letras mai√∫sculas e min√∫sculas e separa√ß√£o sil√°bica. Ainda s√£o analisadas a reg√™ncia verbal e nominal, concord√¢ncia verbal e nominal, pontua√ß√£o, paralelismo, emprego de pronomes e crase.

S√£o seis n√≠veis de desempenho:

200 pontos: Demonstra excelente dom√≠nio da modalidade escrita formal da l√≠ngua portuguesa e de escolha de registro. Desvios gramaticais ou de conven√ß√µes da escrita ser√£o aceitos somente com excepcionalidade e quando n√£o caracterizarem reincid√™ncia.

160 pontos: Demonstra bom dom√≠nio da modalidade escrita formal da l√≠ngua portuguesa e de escolha de registro, com poucos desvios gramaticais e de conven√ß√µes da escrita.

120 pontos: Demonstra dom√≠nio mediano da modalidade escrita formal da l√≠ngua portuguesa e de escolha de registro, com alguns desvios gramaticais e de conven√ß√µes da escrita.

80 pontos: Demonstra dom√≠nio insuficiente da modalidade escrita formal da l√≠ngua portuguesa, com muitos desvios gramaticais, de escolha de registro e de conven√ß√µes da escrita.

40 pontos: Demonstra dom√≠nio prec√°rio da modalidade escrita formal da l√≠ngua portuguesa, de forma sistem√°tica, com diversificados e frequentes desvios gramaticais, de escolha de registro e de conven√ß√µes da escrita.

0 ponto: Demonstra desconhecimento da modalidade escrita formal da l√≠ngua portuguesa.
""",
    "competencia_2": """
2. Compreender o tema e n√£o fugir do que √© proposto
Avalia as habilidades integradas de leitura e de escrita do candidato. O tema constitui o n√∫cleo das ideias sobre as quais a reda√ß√£o deve ser organizada e √© caracterizado por ser uma delimita√ß√£o de um assunto mais abrangente.

Eis os seis n√≠veis de desempenho:

200 pontos: Desenvolve o tema por meio de argumenta√ß√£o consistente, a partir de um repert√≥rio sociocultural produtivo e apresenta excelente dom√≠nio do texto dissertativo-argumentativo.

160 pontos: Desenvolve o tema por meio de argumenta√ß√£o consistente e apresenta bom dom√≠nio do texto dissertativo-argumentativo, com proposi√ß√£o, argumenta√ß√£o e conclus√£o.

120 pontos: Desenvolve o tema por meio de argumenta√ß√£o previs√≠vel e apresenta dom√≠nio mediano do texto dissertativo-argumentativo, com proposi√ß√£o, argumenta√ß√£o e conclus√£o.

80 pontos: Desenvolve o tema recorrendo √† c√≥pia de trechos dos textos motivadores ou apresenta dom√≠nio insuficiente do texto dissertativo-argumentativo, n√£o atendendo √† estrutura com proposi√ß√£o, argumenta√ß√£o e conclus√£o.

40 pontos: Apresenta o assunto, tangenciando o tema, ou demonstra dom√≠nio prec√°rio do texto dissertativo-argumentativo, com tra√ßos constantes de outros tipos textuais.

0 ponto: Fuga ao tema/n√£o atendimento √† estrutura dissertativo-argumentativa. Nestes casos a reda√ß√£o recebe nota zero e √© anulada.
""",
    "competencia_3": """
3. Selecionar, relacionar, organizar e interpretar informa√ß√µes, fatos, opini√µes e argumentos em defesa de um ponto de vista
O candidato precisa elaborar um texto que apresente, claramente, uma ideia a ser defendida e os argumentos que justifiquem a posi√ß√£o assumida em rela√ß√£o √† tem√°tica da proposta da reda√ß√£o. Trata da coer√™ncia e da plausibilidade entre as ideias apresentadas no texto, o que √© garantido pelo planejamento pr√©vio √† escrita, ou seja, pela elabora√ß√£o de um projeto de texto.

Eis os seis n√≠veis de desempenho:

200 pontos: Apresenta informa√ß√µes, fatos e opini√µes relacionados ao tema proposto, de forma consistente e organizada, configurando autoria, em defesa de um ponto de vista.

160 pontos: Apresenta informa√ß√µes, fatos e opini√µes relacionados ao tema, de forma organizada, com ind√≠cios de autoria, em defesa de um ponto de vista.

120 pontos: Apresenta informa√ß√µes, fatos e opini√µes relacionados ao tema, limitados aos argumentos dos textos motivadores e pouco organizados, em defesa de um ponto de vista.

80 pontos: Apresenta informa√ß√µes, fatos e opini√µes relacionados ao tema, mas desorganizados ou contradit√≥rios e limitados aos argumentos dos textos motivadores, em defesa de um ponto de vista.

40 pontos: Apresenta informa√ß√µes, fatos e opini√µes pouco relacionados ao tema ou incoerentes e sem defesa de um ponto de vista.

0 ponto: Apresenta informa√ß√µes, fatos e opini√µes n√£o relacionados ao tema e sem defesa de um ponto de vista.
""",
    "competencia_4": """
4. Conhecimento dos mecanismos lingu√≠sticos necess√°rios para a constru√ß√£o da argumenta√ß√£o
S√£o avaliados itens relacionados √† estrutura√ß√£o l√≥gica e formal entre as partes da reda√ß√£o. A organiza√ß√£o textual exige que as frases e os par√°grafos estabele√ßam entre si uma rela√ß√£o que garanta uma sequ√™ncia coerente do texto e a interdepend√™ncia entre as ideias.

Preposi√ß√µes, conjun√ß√µes, adv√©rbios e locu√ß√µes adverbiais s√£o respons√°veis pela coes√£o do texto porque estabelecem uma inter-rela√ß√£o entre ora√ß√µes, frases e par√°grafos. Cada par√°grafo ser√° composto por um ou mais per√≠odos tamb√©m articulados. Cada ideia nova precisa estabelecer rela√ß√£o com as anteriores.

Abaixo, seguem os seis n√≠veis de desempenho:

200 pontos: Articula bem as partes do texto e apresenta repert√≥rio diversificado de recursos coesivos.

160 pontos: Articula as partes do texto, com poucas inadequa√ß√µes, e apresenta repert√≥rio diversificado de recursos coesivos.

120 pontos: Articula as partes do texto, de forma mediana, com inadequa√ß√µes, e apresenta repert√≥rio pouco diversificado de recursos coesivos.

80 pontos: Articula as partes do texto, de forma insuficiente, com muitas inadequa√ß√µes e apresenta repert√≥rio limitado de recursos coesivos.

40 pontos: Articula as partes do texto de forma prec√°ria.

0 ponto: N√£o articula as informa√ß√µes.
""",
    "competencia_5": """
5. Respeito aos direitos humanos
Apresentar uma proposta de interven√ß√£o para o problema abordado que respeite os direitos humanos. Propor uma interven√ß√£o para o problema apresentado pelo tema significa sugerir uma iniciativa que busque, mesmo que minimamente, enfrent√°-lo. A elabora√ß√£o de uma proposta de interven√ß√£o na prova de reda√ß√£o do Enem representa uma ocasi√£o para que o candidato demonstre o preparo para o exerc√≠cio da cidadania, para atuar na realidade em conson√¢ncia com os direitos humanos.

Eis os seis n√≠veis de desempenho:

200 pontos: Elabora muito bem proposta de interven√ß√£o, detalhada, relacionada ao tema e articulada √† discuss√£o desenvolvida no texto.

160 pontos: Elabora bem proposta de interven√ß√£o relacionada ao tema e articulada √† discuss√£o desenvolvida no texto.

120 pontos: Elabora, de forma mediana, proposta de interven√ß√£o relacionada ao tema e articulada √† discuss√£o desenvolvida no texto.

80 pontos: Elabora, de forma insuficiente, proposta de interven√ß√£o relacionada ao tema, ou n√£o articulada com a discuss√£o desenvolvida no texto.

40 pontos: Apresenta proposta de interven√ß√£o vaga, prec√°ria ou relacionada apenas ao assunto.

0 ponto: N√£o apresenta proposta de interven√ß√£o ou apresenta proposta n√£o relacionada ao tema ou ao assunto.
"""
}
# Cria√ß√£o dos agentes individuais para cada compet√™ncia
def criar_agente_competencia(id_comp, descricao):
    return LlmAgent(
        name=id_comp,
        model=MODEL_ID,
        instruction=f"""
Voc√™ √© um corretor experiente do ENEM. Avalie APENAS a compet√™ncia a seguir no texto da reda√ß√£o apresentado.

Crit√©rio a ser avaliado:
{descricao}

Siga rigorosamente os n√≠veis de pontua√ß√£o (0, 40, 80, 120, 160, 200) com base apenas nesta compet√™ncia.

Responda apenas no seguinte formato:
Nota: [n√∫mero exato]
Justificativa: [entre 3 e 5 linhas, claras e objetivas]

Reda√ß√£o para refer√™ncia com desempenho ALTO:
{redacao_nota_alta}

Reda√ß√£o para refer√™ncia com desempenho BAIXO:
{redacao_nota_baixa}"""
    )

# Criar todos os agentes
agentes = [criar_agente_competencia(f"competencia_{i}", competencias[f"competencia_{i}"]) for i in range(1, 6)]

# Criar agente sequencial
avaliador = SequentialAgent(
    name="avaliador_redacao_enem",
    sub_agents=agentes
)

# Fun√ß√£o de avalia√ß√£o da reda√ß√£o
def avaliar_redacao_completa(redacao):
    session_service = InMemorySessionService()
    runner = Runner(agent=avaliador, app_name="avaliador_redacao", session_service=session_service)

    session = session_service.create_session(
        app_name="avaliador_redacao",
        user_id="usuario",
        session_id="sessao1"
    )

    content = types.Content(role="user", parts=[types.Part(text=redacao)])

    print(" Iniciando avalia√ß√£o...\n")
    nota_total = 0

    competencias_nomes = [
        "Compet√™ncia 1: Dom√≠nio da escrita formal da l√≠ngua portuguesa",
        "Compet√™ncia 2: Compreens√£o do tema",
        "Compet√™ncia 3: Argumenta√ß√£o",
        "Compet√™ncia 4: Coes√£o e coer√™ncia",
        "Compet√™ncia 5: Proposta de interven√ß√£o"
    ]

    avaliacoes = []
    for event in runner.run(user_id="usuario", session_id="sessao1", new_message=content):
        if event.is_final_response():
            avaliacoes.append(event.content.parts[0].text)

    for i, texto in enumerate(avaliacoes):
        print(f"\nüìò Avalia√ß√£o da {competencias_nomes[i]}:\n")
        print(texto)
        match = re.search(r"(?i)nota[:\-]?\s*(\d+)", texto)
        if match:
            nota_total += int(match.group(1))

    print(f"\n Nota final: {nota_total}/1000")



# Widgets e interface
tema_widget = widgets.Text(
    value='',
    placeholder='Digite o tema da reda√ß√£o...',
    description='Tema:',
    layout=widgets.Layout(width='100%')
)

redacao_widget = widgets.Textarea(
    value='',
    placeholder='Cole ou escreva aqui sua reda√ß√£o completa...',
    description='Reda√ß√£o:',
    layout=widgets.Layout(width='100%', height='300px')
)

botao = widgets.Button(description=" Avaliar Reda√ß√£o", button_style='success')
saida = widgets.Output()

def ao_clicar(botao):
    saida.clear_output()
    tema = tema_widget.value.strip()
    redacao = redacao_widget.value.strip()

    with saida:
        if not tema or not redacao:
            print(" Preencha o tema e a reda√ß√£o.")
        else:
            print(f"Tema: {tema}\n")
            avaliar_redacao_completa(redacao)

botao.on_click(ao_clicar)

# Mostrar interface
display(tema_widget, redacao_widget, botao, saida)
